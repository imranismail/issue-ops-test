name: diff

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  pull-requests: write
  contents: write
  checks: read

jobs:
  ilock:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request }}
    steps:
      - name: ilock
        uses: github/lock@v2.1.1
        with:
          environment: global
          lock_trigger: /lock
          unlock_trigger: /unlock
          lock_info_alias: /wcid
  unlock:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' }}
    steps:
      - name: unlock
        uses: github/lock@v2.1.1
        with:
          environment: global
          mode: unlock
  diff:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/diff') }}
    steps:
      - name: acknowledge
        uses: GrantBirki/comment@v2.0.7
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

      - name: lock
        id: lock
        uses: github/lock@v2.1.1
        with:
          environment: global
          mode: check

      - name: locked_comment
        uses: GrantBirki/comment@v2.0.7
        if: ${{ steps.lock.outputs.locked == 'true' && steps.lock.outputs.created_by != github.actor }}
        with:
          issue-number: ${{ github.event.number }}
          body: |
            This repo is currently locked by ${{ steps.lock.outputs.created_by }}. Please wait for them to finish before trying again.

      - name: acquire_lock
        uses: github/lock@v2.1.1
        if: ${{ steps.lock.outputs.locked == 'false' }}
        with:
          environment: global
          mode: lock

      - name: diff
        uses: GrantBirki/comment@v2.0.7
        if: ${{ steps.lock.outputs.locked == 'false' || steps.lock.outputs.locked == 'true' && steps.lock.outputs.created_by == github.actor }}
        with:
          issue-number: ${{ github.event.number }}
          body: |
            Diffing deployment!

      - name: success
        uses: GrantBirki/comment@v2.0.7
        if: ${{ success() }}
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "+1"

      - name: failure
        uses: GrantBirki/comment@v2.0.7
        if: ${{ failure() }}
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "-1"

      # - name: branch-deploy
      #   id: branch-deploy
      #   uses: imranismail/branch-deploy@main
      #   with:
      #     allow_forks: false
      #     environment: global
      #     noop_trigger: .diff
      #     trigger_message_template: |
      #       {% set deploymentType = "diff" if noop else "deployment" %}
      #       ### {{ deploymentType | title }} Triggered üöÄ

      #       {{ actor }} started a {{ deploymentType | lower }} to **{{ environment }}**

      #       You can watch the progress [here]({{ log_url }}) üîó
      #     deploy_message_template: |
      #       {% set deploymentType = "diff" if noop else "deploy" %}
      #       {% set emoji = "‚ö†Ô∏è" %}
      #       {% set message = ["**", actor, "**", " ", deploymentType, "ed",  "ref", " ", "`", ref, "`"] %}
      #       {% if status === "success" -%}
      #         {% set emoji = "‚úÖ" %}
      #         {% set message = ["**", actor, "**", " ", "successfully", " ", deploymentType, "ed" ," ", "ref", " ", "`", ref, "`", " ", "to", " ", "**", environment, "**"] %}
      #       {%- elif status === "failure" -%}
      #         {% set emoji = "‚ùå" %}
      #         {% set message = ["**", actor, "**", " ", "had a failure when", " ", deploymentType, "ing", " ", "ref", " ", "`", ref, "`", "to", " ", "**", environment, "**"] %}
      #       {%- endif %}

      #       ### {{ "Deployment" if deploymentType == "deploy" else "Diff" }} Results {{ emoji }}

      #       {{ message | join }}

      # - name: diff
      #   if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' }}
      #   shell: bash
      #   run: |
      #     echo "Doing diff stuff on ${{steps.branch-deploy.outputs.environment}}"

      # - name: deploy
      #   if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop != 'true' }}
      #   shell: bash
      #   run: |
      #     echo "Doing deploy stuff on ${{steps.branch-deploy.outputs.environment}}"
